{{### response.files.append("/curator/static/js/d3.v3.js") }}
{{ response.files.append("/curator/static/js/d3.v3.min.js") }}
{{extend 'layout.html'}}
{{import urllib}}
{{from pprint import pprint}}
{{### Add support scripts for parsing ISO-8601 dates
  #response.files.append(URL('static','js/moment.min.js'))
}}
<style type="text/css">
.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}
.bar {
  fill: steelblue;
}
.x.axis path {
  display: none;
}
.y.axis .tick line {
    stroke: #000;
    opacity: 0.15;
}
.y.axis path.domain {
    fill: none;
}
.highlight-details-box {
    stroke: #ccc;
    fill: #fff;
    opacity: 0.8;
}
.highlight-details-title {
    font-size: 12px;
    font-weight: bold;
    stroke: none;
    fill: #000;
}
.highlight-details-stat {
    font-size: 12px;
    font-weight: normal;
    fill: #333;
}

.event-markers .synth-release-marker,
.event-markers .taxo-release-marker {
    visibility: hidden;
}
circle.synth-release-marker {
    fill: #9b8f56;
}
circle.taxo-release-marker {
    fill: #347592;
}
.event-markers .date-with-synthesis circle.synth-release-marker,
.event-markers .date-with-synthesis text.synth-release-marker {
    visibility: visible;
}
.event-markers .date-with-taxonomy circle.taxo-release-marker,
.event-markers .date-with-taxonomy text.taxo-release-marker  {
    visibility: visible;
}
.event-markers text {
    fill: #fff;
    font-size: 8px;
    cursor: pointer;
}
.event-marker:hover circle {
    stroke: red;
    stroke-width: 2px;
    stroke-opacity: 0.5;
}
*/
</style>
<div class="container">
    <h1 id="main-title" style="display: inline-block; padding-bottom: 12px;">Synthesis release 
    </h1>
                  &nbsp;
                  <select id="synthesis-profile-date-chooser" style="">
                  </select>
                  &nbsp;
                  <div class="pagination hidden-tablet" style="display: inline-block; vertical-align: middle; line-height: 30px;">
                    <ul>
                        <li id="prev-synthesis-profile"><a href="#">Prev</a></li>
                        <li id="next-synthesis-profile"><a href="#">Next</a></li>
                    </ul>
                  </div>

      <div class="row">
          <div class="span10 offset1">
              <!-- TODO: Relax the margin-top if we're on a narrow screen (stacked columns), to avoid overlap. -->

              <div style="margin-top: -16px;">
                  <a href="/about/progress?highlight={{= release_version }}">Show this release in the history of Open Tree</a>
              </div>

              <h3>Statistics</h3>

              <div id="synthesis-stats-missing" class="alert alert-error" style="display: none;">
                  No synthesis statistics found!
              </div>

              <div id="synthesis-stats-panel" class="stats-panel" style="display: none;">

                  <table class="table table-condensed table-hover" style="clear: left;"></table>
              </div>

              <h3 style="clear: both;">Downloads</h3>
              <p style="font-style: italic;">
                TODO: Read download files list from static site?
              </p>

              <h3>Notes</h3>
              <p style="font-style: italic;">
                TODO: Render README (markdown =&gt; HTML) from static files?
              </p>

              <h3>Sources</h3>
              <p style="font-style: italic;">
                TODO: Link to taxonomy release used in this synthesis?</a>
              </p>
              <p style="font-style: italic;">
                TODO: List all trees and studies (mimic Bibliographic Refs page?)
              </p>

          </div>
      </div>

      <h3 id="comment-header">Comments <i></i></h3>
      {{=plugin_localcomments(filter=('url',),url=request.url)}}

</div><!-- end of .container -->

      <div id="stacked-bar-div" />
<script type="text/javascript">
// pass statistics as JSON to client for stepping, plotting, etc.
// NOTE that these are correctly date-sorted from the server!
{{ if synthesis_stats: 
    # NOTE that we use XML() here to decode HTML entities like &quot; }}
var synthesis_stats = {{= XML(json.dumps(synthesis_stats)) }};
{{ else: }}
var synthesis_stats = null;
{{ pass }}

// jimA: TEMPORARILY restricting this to just a few samples (for review)
//otu_stats = otu_stats.slice(0,4);

var warnings = [ ]; {{## = XML(warnings)}};
for (i = 0; i < warnings.length; ++i) {
    $('#warnings-panel').append("<p style=\"font-weight:bold;color:red\">" + warnings[i] + "</p>");
}

var sortedSynthesisProfileKeys = null;
var currentSynthesisProfileDate = null;

var sortedPhylesystemProfileKeys = null;
var currentPhylesystemProfileDate = null;

var releaseVersion = '{{= release_version }}';

$(document).ready(function() {
    // show current profiles, or a notice if no data was found 
    if (synthesis_stats) {
        // load and sort its keys (profile dates) in chronological order
        sortedSynthesisProfileKeys = $.map(
            synthesis_stats, 
            function( ignoreValue, profileDate ) {
                return profileDate; // its JSON property
            }
        ).sort();

        // start with the profile whose date is in the URL (or latest, by default)
        if (releaseVersion) {
            currentSynthesisProfileDate = releaseVersion;
        } else {
            currentSynthesisProfileDate = sortedSynthesisProfileKeys[ sortedSynthesisProfileKeys.length - 1 ];
        }
        // format nicely and add to page title
        var displayDate = formatISODate( currentSynthesisProfileDate, {includeTime: false} );
        $('#title-date').html( "("+ displayDate +")" );

        // bind Prev and Next buttons
        $('#prev-synthesis-profile').click(function() {
            var nthProfile = sortedSynthesisProfileKeys.indexOf(currentSynthesisProfileDate);
            // sanity check
            if (nthProfile === 0) return false;
            var anotherDate = sortedSynthesisProfileKeys[nthProfile - 1];
            jumpToSynthesisProfileDate(anotherDate);

            return false;
        });
        $('#next-synthesis-profile').click(function() {
            var nthProfile = sortedSynthesisProfileKeys.indexOf(currentSynthesisProfileDate);
            // sanity check
            if (nthProfile === sortedSynthesisProfileKeys.length - 1) return false;
            var anotherDate = sortedSynthesisProfileKeys[nthProfile + 1];
            jumpToSynthesisProfileDate(anotherDate);
            return false;
        });

        // build and bind profile-date chooser
        $('#synthesis-profile-date-chooser').empty();
        $.each( sortedSynthesisProfileKeys, function (i, profileDate) {
            var displayDate = formatISODate( profileDate, {includeTime: false} );
            $('#synthesis-profile-date-chooser').prepend(
                '<option value="'+ profileDate +'">'+ displayDate +'</option>'
            );
        });
        $('#synthesis-profile-date-chooser').change(function() {
            var anotherDate = $(this).val();
            jumpToSynthesisProfileDate(anotherDate);
        });

        showCurrentSynthesisProfile();
        $('#synthesis-stats-panel').show();

    } else {
        $('#synthesis-stats-missing').show();
    }
});

function formatISODate( dateString, options ) {
    options = options || {includeTime: true};
    var aDate = new moment(dateString);
    // see http://momentjs.com/docs/#/parsing/string/
    if (options.includeTime) {
        return aDate.format('MMMM D, YYYY, hA');
    } else {
        return aDate.format('MMMM D, YYYY');
    }
}

function jumpToSynthesisProfileDate( targetDate ) {
    // move this page to the chosen date
    var currentURL = window.location.href;
    var urlParts = currentURL.split('/');
    // ASSUME there's always a date in the final URL-part
    var currentDate = urlParts.pop();
    urlParts.push(targetDate);  // convert to string?
    var newURL = urlParts.join('/');
    window.location.href = newURL;
}

function showCurrentSynthesisProfile() {
    var currentSynthesisProfile = synthesis_stats[ currentSynthesisProfileDate ];
    // Our stats JSON has friendly property names. Just format them!
    $('#synthesis-stats-panel table').empty();
    for (var prop in currentSynthesisProfile) {
        if (prop === 'Date') continue;
        var itsValue = currentSynthesisProfile[ prop ];
        $('#synthesis-stats-panel table').append(
            '<tr>'
              + '<th>'+ prop +'</th>'
              + '<td>'+ itsValue +'</td>'
              // for sparkline specs, see http://style.org/chartapi/sparklines/
              + '<td>'
                  + '<img width="50: height="20" src="//chart.googleapis.com/chart?'
                    + 'cht=lc'
                    + '&chs=50x20'
                    + '&chd=t:'+ getSynthesisSparklineData(prop, currentSynthesisProfileDate)
                    + '&chco=336699'
                    + '&chls=1,1,0'
                    + '&chm=o,990000,0,20,4'
                    + '&chxt=r,x,y'
                    + '&chxs=0,990000,11,0,_|1,990000,1,0,_|2,990000,1,0,_'
                    + '&chxl=0:||1:||2:||'
                  + '" title="Previous history for this statistic">'
              +'</td>'
          + '</tr>'
        );
    }

    // Update the Next and Prev buttons (disable if no more)
    var nthProfile = sortedSynthesisProfileKeys.indexOf(currentSynthesisProfileDate);
    if (nthProfile === 0) {
        $('#prev-synthesis-profile').addClass('disabled');
    } else {
        $('#prev-synthesis-profile').removeClass('disabled');
    }
    if (nthProfile === (sortedSynthesisProfileKeys.length - 1)) {
        $('#next-synthesis-profile').addClass('disabled');
    } else {
        $('#next-synthesis-profile').removeClass('disabled');
    }

    // Update the date selector
    $('#synthesis-profile-date-chooser').val(currentSynthesisProfileDate);
}

function getSynthesisSparklineData(prop, lastProfileDate) {
    // return a comma-delimited data series (string) for plotting
    // NOTE that these should be decimal numbers between 0 and 100, so scale accordingly
    //   EXAMPLE: '5.3,26.5,15.9,31.7,42.3,21.2'
    var series = [];
    $.each(sortedSynthesisProfileKeys, function(i, profileDate) {
        // skip more recent profiles, if we're looking at something older
        if (profileDate <= lastProfileDate) {
             series.push( synthesis_stats[profileDate][prop] );
        }
    });

    // normalize all values in the series to the range 0.0 to 100.0
    var minValue = Math.min.apply(Math, series);
    var maxValue = Math.max.apply(Math, series);
    // move all values above zero
    if (minValue < 0) {
        series = $.map(series, function(d) {
            return d - minValue;
        });
    }
    // scale all values to under 100 (using 90 to avoid cropping)
    var scaleToFit = 90.0 / maxValue;
    series = $.map(series, function(d) {
        return d * scaleToFit;
    });

    return series.join(',');
}

</script>
